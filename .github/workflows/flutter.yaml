name: Flutter CI

on:
  push:
    branches: [main]
    paths-ignore:
      - "docs/**"
      - "**.md"
      - ".markdownlint.json"
      - "LICENSE"
  pull_request:
    branches: [main, 'feat/**', 'fix/**', 'refactor/**', 'chore/**']
    paths-ignore:
      - "docs/**"
      - "**.md"
      - ".markdownlint.json"
      - "LICENSE"
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

env:
  SLACK_NOTIFY_URL: ${{ secrets.SLACK_NOTIFY_URL }}

jobs:
  lint:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v6

      - name: Setup Dart environment
        uses: ./.github/actions/setup-dart-env

      - name: Check formatting
        run: |
          find . -name "*.dart" \
            -not -path "./packages/soliplex_client/lib/src/schema/*" \
            -print0 | xargs -0 dart format --set-exit-if-changed

      - name: Analyze code
        run: flutter analyze --fatal-infos

      - name: Check documentation
        run: |
          dart doc --dry-run
          for dir in packages/*/; do
            echo "::group::dart doc $dir"
            (cd "$dir" && dart doc --dry-run)
            echo "::endgroup::"
          done

      - name: Lint markdown
        run: |
          pip install pymarkdownlnt==0.9.35
          pymarkdown --set extensions.front-matter.enabled=\$!True \
            --disable-rules MD013,MD024,MD033,MD036,MD041,MD060 \
            scan docs/ *.md

  test:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        target:
          - name: app
            path: "."
            runner: flutter
          - name: soliplex_client
            path: packages/soliplex_client
            runner: dart
          - name: soliplex_client_native
            path: packages/soliplex_client_native
            runner: flutter
          - name: soliplex_logging
            path: packages/soliplex_logging
            runner: dart
    steps:
      - uses: actions/checkout@v6

      - name: Setup Dart environment
        uses: ./.github/actions/setup-dart-env
        with:
          working-directory: ${{ matrix.target.path }}
          runner: ${{ matrix.target.runner }}

      - name: Generate random seed
        id: seed
        run: echo "value=$RANDOM" >> "$GITHUB_OUTPUT"

      - name: Run tests
        working-directory: ${{ matrix.target.path }}
        run: |
          SEED="${{ steps.seed.outputs.value }}"
          echo "::notice::Test ordering seed: $SEED"
          if [ "${{ matrix.target.runner }}" = "flutter" ]; then
            flutter test --test-randomize-ordering-seed="$SEED" \
              ${{ matrix.target.name == 'app' && '--coverage' || '' }}
          else
            dart test --test-randomize-ordering-seed="$SEED"
          fi

      - name: Report seed on failure
        if: failure()
        run: |
          SEED="${{ steps.seed.outputs.value }}"
          echo "::error::Tests failed with ordering seed: $SEED"
          echo "Reproduce with: --test-randomize-ordering-seed=$SEED"

      - name: Check coverage threshold
        if: matrix.target.name == 'app'
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq lcov
          COVERAGE=$(lcov --summary coverage/lcov.info 2>&1 \
            | grep "lines" | sed 's/.*: \([0-9.]*\)%.*/\1/')
          echo "Coverage: ${COVERAGE}%"
          if [ -z "$COVERAGE" ]; then
            echo "::error::Could not parse coverage from lcov.info"
            exit 1
          fi
          COVERAGE_INT=${COVERAGE%.*}
          if [ "$COVERAGE_INT" -lt 80 ]; then
            echo "::error::Coverage ${COVERAGE}% is below minimum 80%"
            exit 1
          fi
          echo "::notice::Coverage check passed with ${COVERAGE}%"

      - name: Upload coverage artifact
        if: matrix.target.name == 'app'
        uses: actions/upload-artifact@v6
        with:
          name: coverage-report
          path: coverage/
          retention-days: 7

      - name: Notify Slack on failure
        if: failure() && env.SLACK_NOTIFY_URL != ''
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ env.SLACK_NOTIFY_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "channel": "#soliplex",
              "username": "flutter-ci",
              "text": ${{ toJson(format(':x: Tests failed for {0} on {1}:\n{2}\n{3}/{4}/actions/runs/{5}', matrix.target.name, github.ref, github.event.head_commit.message, github.server_url, github.repository, github.run_id)) }},
              "icon_emoji": ":flutter:"
            }

  build-web:
    needs: [lint]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v6

      - name: Setup Dart environment
        uses: ./.github/actions/setup-dart-env

      - name: Build web
        run: flutter build web --release

      - name: Upload web artifact
        uses: actions/upload-artifact@v6
        with:
          name: web-build
          path: build/web/
          retention-days: 7

      - name: Notify Slack on failure
        if: failure() && env.SLACK_NOTIFY_URL != ''
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ env.SLACK_NOTIFY_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "channel": "#soliplex",
              "username": "flutter-ci",
              "text": ${{ toJson(format(':x: Web build failed on {0}:\n{1}\n{2}/{3}/actions/runs/{4}', github.ref, github.event.head_commit.message, github.server_url, github.repository, github.run_id)) }},
              "icon_emoji": ":flutter:"
            }
